<script setup>
import { reactive, ref, watch } from 'vue'
import draggable from 'vuedraggable'
import Column from './Column.vue'
import debounce from 'lodash.debounce'

const columns = reactive([
  { id: 'asset', title: 'è³‡ç”¢', subCategories: [] },
  { id: 'liability', title: 'è² å‚µ', subCategories: [] },
  { id: 'other', title: 'å…¶ä»–', subCategories: [] }
])

const editingSubId = ref(null)
const isSaving = ref(false)
const isSaved = ref(false)

// æ¨¡æ“¬ API
async function saveToServer(data) {
  return new Promise(resolve => {
    setTimeout(() => {
      console.log('é€å‡ºåˆ°å¾Œç«¯:', JSON.stringify(data, null, 2))
      resolve(true)
    }, 800)
  })
}

// debounce åŒ…è£
const debouncedSave = debounce(async () => {
  isSaving.value = true
  isSaved.value = false
  await saveToServer(columns)
  isSaving.value = false
  isSaved.value = true
  setTimeout(() => (isSaved.value = false), 2000)
}, 500)

// ç›£è½ columns æ·±å±¤è®ŠåŒ–
watch(columns, () => {
  debouncedSave()
}, { deep: true })

// å…¶ä»–æ“ä½œï¼ˆæ–°å¢/åˆªé™¤ï¼‰
const addSubCategory = (columnId) => {
  const col = columns.find(c => c.id === columnId)
  if (col) {
    col.subCategories.push({ id: Date.now().toString(), title: 'æ–°å°æ¨™é¡Œ', items: [] })
  }
}
</script>

<template>
  <div class="board">
    <draggable v-model="columns" item-key="id" group="columns" class="board-container">
      <template #item="{ element: col }">
        <Column
          :column="col"
          :editing-sub-id="editingSubId"
          @add-sub="addSubCategory"
        />
      </template>
    </draggable>

    <!-- ç‹€æ…‹æç¤º -->
    <div>
      <span v-if="isSaving">ğŸ’¾ å„²å­˜ä¸­...</span>
      <span v-else-if="isSaved">âœ… å·²å„²å­˜</span>
    </div>
  </div>
</template>
